---
title: DNS解析过程
date: 2020-04-08 19:01:48
urlname: dns-resolve
categories:
- network
tags:
- dns
---
>在日常的开发和问题排查中，难免会遇到DNS解析的问题，尤其是在云计算中，内部组件因为DNS解析问题导致的问题层出不穷。借此，总计一下基本的DNS原理，以及日常生活中，一次DNS解析的过程。

<!--more-->

#### 为什么需要DNS解析？
在互联网通信中，大部分应用基于TCP/IP的，而TCP/IP是基于IP地址的，所以计算机在网络层只能识别"192.168.1.24"之类的IP地址，而不能认识域名。而互联网大量的服务是无法全部通过IP给用户提供服务的，用户无法记住这么多的IP地址，并且固定IP地址也不利于互联网服务的高可用实现，域名相对来说用户能够容易记住和使用，**www.baidu.com** 肯定比61.135.169.125这种地址方便访问，那么为了能够使用域名进行互联网访问，就需要一个翻译器（DNS）讲域名翻译为对应的IP地址。

#### DNS是什么
DNS的全称是**（Domain Name System）**，即域名系统。DNS是因特网上作为域名和IP地址相互映射的一个分布式数据库，能够使用户更方便的去访问互联网而不用去记住能够被机器直接读取的IP地址。通过域名，最终得到该域名对应的IP地址的过程则是域名解析的过程。

#### DNS如何解析

##### 1. 递归查询
某天，客户端想要访问XXX网站，但是，客户端并不知道XXX网站的IP地址。于是，展开了如下对话
- 客户端：“本地DNS服务器大佬，求问XXX的IP地址是多少？”
- 本地DNS服务器：“不好意思，我不知道，但是根域名服务器可能会知道，我替去问他吧”
- 本地DNS服务器：“根域名服务器大佬，求问XXX的IP地址是多少？”
- 根域名服务器：“不好意思，我不也知道，但是A顶级域名服务器可能会知道，我替你去问他吧”
- 根域名服务器：“A顶级域名服务器，求问XXX的IP地址是多少？”
- A顶级域名服务器：“不好意思，我不也知道，但是B域名服务器可能会知道，我替你去问他吧”
- A顶级域名服务器：“B域名服务器，求问XXX的IP地址是多少？”
- B域名服务器：“A顶级域名服务器，查到XXX的IP地址是192.168.168.6”
- A顶级域名服务器：“根域名服务器，查到XXX的IP地址是192.168.168.6”
- 根域名服务器：“本地DNS服务器，查到XXX的IP地址是192.168.168.6”
- 本地DNS服务器： “客户端，查到XXX的IP地址是192.168.168.6”
- 客户端：“谢谢各位大佬，XXX的IP地址是192.168.168.6，我可以和他愉快的通讯了”
![dns 递归查询](https://user-gold-cdn.xitu.io/2018/5/27/1639fd992859d5f1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

##### 2. 迭代查询

客户端：“本地DNS服务器大佬，求问XXX的IP地址是多少？”
- 本地DNS服务器：“不好意思，我不知道，但是根域名服务器可能会知道，你去问他吧”，本地DNS服务器说完，并把根域名服务器地址发给客户端。
- 客户端：“根域名服务器大佬，求问XXX的IP地址是多少？”
- 根域名服务器：“不好意思，我不也知道，但是A顶级域名服务器可能会知道，你去问他吧”，根域名服务器说完，并把A顶级域名服务器地址发给客户端。
- 客户端只能又跑去问A顶级域名服务器了。
- 客户端：“A顶级域名服务器大佬，求问XXX的IP地址是多少？”
- A顶级域名服务器：“不好意思，我不也知道，但是B域名服务器可能会知道，你去问他吧”，A顶级域名服务器说完，并把B域名服务器地址发给客户端。
- 客户端非常无奈，只能又跑去问B域名服务器了。
- 客户端：“B域名服务器大佬，求问XXX的IP地址是多少？”
- B域名服务器：“客户端同学，查到XXX的IP地址是192.168.168.6”。
- 客户端：“谢谢B域名服务器大佬，XXX的IP地址是192.168.168.6，我可以和他愉快的通讯了”
就这样，客户端在询问了一大圈之后，终于知道了XXX的IP地址了。
![dns 迭代查询](https://user-gold-cdn.xitu.io/2018/5/27/1639fdb27f876e0d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

##### 缓存
实际上，在DNS查询过程中，客户端和服务器也都会加入缓存的机制，这样可以减少查询的次数，加快域名解析过程。

#### 一次请求的DNS解析过程

1. 在浏览器中输入**www.baidu.com** 域名，操作系统会先检查自己本地的hosts文件是否有这个网址映射关系，如果有，就先调用这个IP地址映射，完成域名解析。 

2. 如果hosts里没有这个域名的映射，则查找本地DNS解析器缓存，是否有这个网址映射关系，如果有，直接返回，完成域名解析。 

3. 如果hosts与本地DNS解析器缓存都没有相应的网址映射关系，首先会找TCP/IP参数中设置的首选DNS服务器，在此我们叫它本地DNS服务器，此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。 

4. 如果要查询的域名，不由本地DNS服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个IP地址映射，完成域名解析，此解析不具有权威性。

5. 如果本地DNS服务器本地区域文件与缓存解析都失效，则根据本地DNS服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地DNS就把请求发至13台根DNS，根DNS服务器收到请求后会判断这个域名(**.com**)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP。本地DNS服务器收到IP信息后，将会联系负责.com域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com域的下一级DNS服务器地址**qq.com**域服务器，重复上面的动作，进行查询，直至找到**www.baidu.com** 

6. 如果用的是转发模式，此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把转请求转至上上级，以此循环。不管是本地DNS服务器用是是转发，还是根提示，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户机。


**TIP**: 从客户端到本地DNS服务器是属于递归查询，而DNS服务器之间就是的交互查询就是迭代查询。
![解析过程](https://pic4.zhimg.com/80/7fcd81756bdc8b52ade0531402c43e43_720w.jpg)


